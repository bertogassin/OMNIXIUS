<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>Oracle · AI — OMNIXIUS</title>
  <link rel="stylesheet" href="../css/style.css">
  <link rel="stylesheet" href="css/app.css">
  <link rel="stylesheet" href="css/ai.css">
</head>
<body>
  <header class="header">
    <div class="container">
      <a href="../index.html" class="logo">OMNIXIUS</a>
      <nav class="nav nav-main nav-unified">
        <div class="nav-group nav-group-main">
          <span class="nav-group-label" data-i18n="navMain">Main</span>
          <a href="../index.html" data-i18n="home">Home</a>
          <a href="login.html" id="navLogin" class="nav-cta" data-i18n="signIn">Sign in</a>
          <a href="#" id="navLogout" style="display:none;" data-i18n="signOut">Sign out</a>
        </div>
        <div class="nav-group nav-group-app">
          <span class="nav-group-label" data-i18n="navApp">App</span>
          <a href="marketplace.html" data-i18n="navTrove">Trove · marketplace</a>
          <a href="mail.html" data-i18n="navRelay">Relay · mail</a>
          <a href="orders.html" data-i18n="navOrders">Orders</a>
          <a href="dashboard.html" data-i18n="navProfile">Profile</a>
          <a href="ai.html" data-i18n="navOracle" style="color:var(--accent);">Oracle · AI</a>
        </div>
        <div class="nav-group nav-group-more nav-drop">
          <span class="nav-group-label" data-i18n="navMore">More</span>
          <button type="button" class="nav-drop-trigger" aria-expanded="false" aria-haspopup="true"><span data-i18n="navMore">More</span> ▾</button>
          <div class="nav-drop-panel">
            <a href="trade.html" data-i18n="brandForge">Forge · trade & finance</a>
            <a href="connect.html" data-i18n="brandBond">Bond · social</a>
            <a href="repositorium.html" data-i18n="brandArk">Ark · storage</a>
            <a href="ixi.html" data-i18n="brandIxi">IXI · blockchain</a>
            <a href="vault.html" data-i18n="brandCrate">Crate · files</a>
            <a href="learning.html" data-i18n="brandAscent">Ascent · learning</a>
            <a href="startups.html" data-i18n="brandFlare">Flare · startups</a>
            <a href="media.html" data-i18n="brandLens">Lens · media</a>
            <a href="rewards.html" data-i18n="brandBounty">Bounty · rewards</a>
          </div>
          <div class="nav-group-app-links">
            <a href="trade.html" data-i18n="brandForge">Forge</a>
            <a href="connect.html" data-i18n="brandBond">Bond</a>
            <a href="repositorium.html" data-i18n="brandArk">Ark</a>
            <a href="ixi.html" data-i18n="brandIxi">IXI</a>
            <a href="vault.html" data-i18n="brandCrate">Crate</a>
            <a href="learning.html" data-i18n="brandAscent">Ascent</a>
            <a href="startups.html" data-i18n="brandFlare">Flare</a>
            <a href="media.html" data-i18n="brandLens">Lens</a>
            <a href="rewards.html" data-i18n="brandBounty">Bounty</a>
          </div>
        </div>
        <div class="nav-group nav-group-info nav-drop">
          <span class="nav-group-label" data-i18n="navInfo">Info</span>
          <button type="button" class="nav-drop-trigger" aria-expanded="false" aria-haspopup="true"><span data-i18n="navInfo">Info</span> ▾</button>
          <div class="nav-drop-panel">
            <a href="../ecosystem.html" data-i18n="navEcosystem">Ecosystem</a>
            <a href="../architecture.html" data-i18n="navArchitecture">Architecture</a>
            <a href="../contact.html" data-i18n="navContact">Contact</a>
          </div>
          <div class="nav-group-app-links">
            <a href="../ecosystem.html">Ecosystem</a>
            <a href="../architecture.html">Architecture</a>
            <a href="../contact.html">Contact</a>
          </div>
        </div>
      </nav>
      <div class="lang-switcher">
        <a href="#" data-lang="en">EN</a>
        <a href="#" data-lang="ru">RU</a>
        <a href="#" data-lang="fr">FR</a>
        <a href="#" data-lang="de">DE</a>
        <a href="#" data-lang="es">ES</a>
        <a href="#" data-lang="it">IT</a>
        <a href="#" data-lang="ar">AR</a>
        <a href="#" data-lang="zh">ZH</a>
        <a href="#" data-lang="ja">JA</a>
      </div>
      <button class="menu-toggle" aria-label="Menu"><span></span></button>
    </div>
  </header>
  <main class="app-page">
    <div class="container ai-page">
      <div class="ai-header">
        <h1>OMNIXIUS AI</h1>
        <p data-i18n="aiHeaderSub">Root of our AI — choose a module and work with chat.</p>
      </div>
      <section class="ai-modules" id="modules">
        <h2 class="ai-modules-title" data-i18n="aiModulesTitle">Universal AI</h2>
        <div class="ai-modules-grid">
          <a href="#code" class="ai-module-card" id="mod-code" data-module="code"><strong data-i18n="aiModule1">Code & Automation</strong><span data-i18n="aiModule1Desc">Code, scripts, automation.</span></a>
          <a href="#data" class="ai-module-card" id="mod-data" data-module="data"><strong data-i18n="aiModule2">Data & Finance</strong><span data-i18n="aiModule2Desc">Data, analytics, finance.</span></a>
          <a href="#tasks" class="ai-module-card" id="mod-tasks" data-module="tasks"><strong data-i18n="aiModule3">Tasks & Productivity</strong><span data-i18n="aiModule3Desc">Tasks, projects, habits, timer.</span></a>
          <a href="#content" class="ai-module-card" id="mod-content" data-module="content"><strong data-i18n="aiModule4">Content, Writing & Messages</strong><span data-i18n="aiModule4Desc">Texts, copy, drafts, writing.</span></a>
          <a href="#media" class="ai-module-card" id="mod-media" data-module="media"><strong data-i18n="aiModule5">Media & Design</strong><span data-i18n="aiModule5Desc">Images, video, design.</span></a>
          <a href="#knowledge" class="ai-module-card" id="mod-knowledge" data-module="knowledge"><strong data-i18n="aiModule6">Knowledge & Education</strong><span data-i18n="aiModule6Desc">Learning, knowledge base.</span></a>
        </div>
      </section>

      <div class="ai-panels">
        <!-- 1. Code & Automation -->
        <div class="ai-panel has-chat active" id="panel-code" data-module="code">
          <div class="panel-workspace" data-module="code">
            <div class="panel-head" data-i18n="aiModule1">Code & Automation</div>
            <div class="toolbar">
              <button type="button" class="btn btn-primary ai-btn-run" data-i18n="aiRun">Run</button>
              <button type="button" class="btn ai-btn-save" data-i18n="aiSave">Save</button>
              <button type="button" class="btn ai-btn-clear" data-i18n="aiClear">Clear</button>
            </div>
            <div class="body">
              <textarea class="code" id="workspace-code" data-i18n-placeholder="aiCodePlaceholder" placeholder="Write or paste code here." spellcheck="false"></textarea>
              <div class="panel-integrations"><span class="panel-integrations-label" data-i18n="aiConnected">Connected:</span><span class="panel-integrations-list" id="integrations-code" data-i18n="aiNone">—</span></div>
            </div>
          </div>
          <div class="panel-chat" data-chat="code">
            <div class="chat-head" data-i18n="aiChatLabel">Chat</div>
            <div class="ai-messages" id="messages-code"></div>
            <div class="ai-offline" data-offline="code" style="display:none;" data-i18n="aiOfflineLong">AI not reachable.</div>
            <div class="ai-quick-actions" data-chat="code">
              <span class="ai-quick-label" data-i18n="aiQuickActions">Actions:</span>
              <button type="button" class="btn btn-sm ai-quick-action" data-chat="code" data-msg="Show my orders" data-i18n="aiActionMyOrders">My orders</button>
              <button type="button" class="btn btn-sm ai-quick-action" data-chat="code" data-msg="My messages summary" data-i18n="aiActionMailSummary">Mail summary</button>
            </div>
            <div class="ai-send" data-send="code">
              <input type="text" data-input="code" data-i18n-placeholder="aiMessagePlaceholder" placeholder="Message…" autocomplete="off">
              <button type="button" class="btn btn-primary" data-sendbtn="code" data-i18n="aiSend">Send</button>
            </div>
          </div>
        </div>

        <!-- 2. Data & Finance -->
        <div class="ai-panel" id="panel-data" data-module="data">
          <div class="panel-workspace" data-module="data">
            <div class="panel-head" data-i18n="aiModule2">Data & Finance</div>
            <div class="toolbar">
              <label class="btn" style="cursor:pointer;" data-i18n="aiImportCsv">Import CSV<input type="file" accept=".csv,.txt" id="data-import-csv" style="position:absolute;opacity:0;width:0;height:0;"></label>
              <button type="button" class="btn ai-btn-parse-data" data-i18n="aiParseToTable">Parse to table</button>
              <button type="button" class="btn btn-primary ai-btn-export" data-i18n="aiExportCsv">Export CSV</button>
              <button type="button" class="btn ai-btn-clear" data-i18n="aiClear">Clear</button>
              <button type="button" class="btn btn-primary ai-btn-analyze" data-i18n="aiAnalyzeWithAi">Analyze with AI</button>
            </div>
            <div class="body">
              <textarea id="workspace-data" data-i18n-placeholder="aiDataPlaceholder" placeholder="Paste CSV or data here." spellcheck="false"></textarea>
              <div class="data-table-wrap" id="data-table-wrap" style="display:none;"><table id="data-table"></table></div>
              <div class="ai-single-result" id="data-ai-result" style="display:none;"></div>
              <div class="panel-integrations"><span class="panel-integrations-label" data-i18n="aiConnected">Connected:</span><span class="panel-integrations-list" id="integrations-data" data-i18n="aiNone">—</span></div>
            </div>
          </div>
        </div>

        <!-- 3. Tasks & Productivity -->
        <div class="ai-panel" id="panel-tasks" data-module="tasks">
          <div class="panel-workspace" data-module="tasks">
            <div class="panel-head" data-i18n="aiModule3">Tasks & Productivity</div>
            <div class="toolbar">
              <button type="button" class="btn btn-primary ai-btn-add-task" data-i18n="aiAddTask">+ Task</button>
              <button type="button" class="btn ai-btn-summarize-notes" data-i18n="aiSummarizeNotes">Summarize notes with AI</button>
              <button type="button" class="btn" id="pomo-start" data-i18n="aiTimer25">Timer 25 min</button>
              <span class="pomo-timer" id="pomo-timer" style="display:none;">25:00</span>
            </div>
            <div class="body">
              <div class="list-add" style="display:none;"><input type="text" id="tasks-task-input" data-i18n-placeholder="aiNewTaskPlaceholder" placeholder="New task…"><select id="tasks-task-status"><option value="todo" data-i18n="aiTodo">To do</option><option value="progress" data-i18n="aiInProgress">In progress</option><option value="done" data-i18n="aiDone">Done</option></select><button type="button" class="btn btn-primary" id="tasks-task-add" data-i18n="aiAdd">Add</button></div>
              <ul class="list-items" id="tasks-tasks"></ul>
              <textarea id="workspace-tasks" data-i18n-placeholder="aiMeetingNotesPlaceholder" placeholder="Meeting notes, daily goals…" style="margin-top:0.75rem; min-height:120px;"></textarea>
              <div class="ai-single-result" id="tasks-ai-result" style="display:none;"></div>
              <div class="panel-integrations"><span class="panel-integrations-label" data-i18n="aiConnected">Connected:</span><span class="panel-integrations-list" id="integrations-tasks" data-i18n="aiNone">—</span></div>
            </div>
          </div>
        </div>

        <!-- 4. Content, Writing & Messages -->
        <div class="ai-panel has-chat" id="panel-content" data-module="content">
          <div class="panel-workspace" data-module="content">
            <div class="panel-head" data-i18n="aiModule4">Content, Writing & Messages</div>
            <div class="toolbar">
              <button type="button" class="btn btn-primary ai-btn-save" data-i18n="aiSave">Save</button>
              <button type="button" class="btn ai-btn-clear" data-i18n="aiClear">Clear</button>
              <button type="button" class="btn btn-primary" id="content-improve-ai" data-i18n="aiImproveWithAi">Improve with AI</button>
            </div>
            <div class="body">
              <span class="word-count" id="content-word-count" style="font-size:0.8rem;color:var(--text-muted);"></span>
              <textarea id="workspace-content" data-i18n-placeholder="aiContentPlaceholder" placeholder="Write text or draft." style="min-height:240px;"></textarea>
              <div class="panel-integrations"><span class="panel-integrations-label" data-i18n="aiConnected">Connected:</span><span class="panel-integrations-list" id="integrations-content" data-i18n="aiNone">—</span></div>
            </div>
          </div>
          <div class="panel-chat" data-chat="content">
            <div class="chat-head" data-i18n="aiChatLabel">Chat</div>
            <div class="ai-messages" id="messages-content"></div>
            <div class="ai-offline" data-offline="content" style="display:none;" data-i18n="aiOfflineShort">AI not reachable.</div>
            <div class="ai-quick-actions" data-chat="content">
              <span class="ai-quick-label" data-i18n="aiQuickActions">Actions:</span>
              <button type="button" class="btn btn-sm ai-quick-action" data-chat="content" data-msg="Show my orders" data-i18n="aiActionMyOrders">My orders</button>
              <button type="button" class="btn btn-sm ai-quick-action" data-chat="content" data-msg="My messages summary" data-i18n="aiActionMailSummary">Mail summary</button>
            </div>
            <div class="ai-send" data-send="content">
              <input type="text" data-input="content" data-i18n-placeholder="aiMessagePlaceholder" placeholder="Message…" autocomplete="off">
              <button type="button" class="btn btn-primary" data-sendbtn="content" data-i18n="aiSend">Send</button>
            </div>
          </div>
        </div>

        <!-- 5. Media & Design -->
        <div class="ai-panel" id="panel-media" data-module="media">
          <div class="panel-workspace" data-module="media">
            <div class="panel-head" data-i18n="aiModule5">Media & Design</div>
            <div class="toolbar"><button type="button" class="btn ai-btn-clear" data-i18n="aiClear">Clear</button></div>
            <div class="body">
              <div class="drop-zone" id="drop-zone-media" data-i18n="aiDropImage">Drop image here or paste URL</div>
              <div class="preview-area" id="preview-media"></div>
              <div class="media-prompt-row">
                <input type="text" id="media-ai-prompt" data-i18n-placeholder="aiAskAiImage" placeholder="Ask AI about this image…">
                <button type="button" class="btn btn-primary" id="media-ai-describe" data-i18n="aiDescribeAnalyze">Describe / Analyze</button>
              </div>
              <div class="ai-single-result" id="media-ai-result" style="display:none;"></div>
              <div class="panel-integrations"><span class="panel-integrations-label" data-i18n="aiConnected">Connected:</span><span class="panel-integrations-list" id="integrations-media" data-i18n="aiNone">—</span></div>
            </div>
          </div>
        </div>

        <!-- 6. Knowledge & Education -->
        <div class="ai-panel has-chat" id="panel-knowledge" data-module="knowledge">
          <div class="panel-workspace" data-module="knowledge">
            <div class="panel-head" data-i18n="aiModule6">Knowledge & Education</div>
            <div class="toolbar">
              <button type="button" class="btn btn-primary ai-btn-save" data-i18n="aiSave">Save</button>
              <button type="button" class="btn ai-btn-clear" data-i18n="aiClear">Clear</button>
            </div>
            <div class="body">
              <textarea id="workspace-knowledge" data-i18n-placeholder="aiKnowledgePlaceholder" placeholder="Notes, questions. Ask AI in chat." style="min-height:240px;"></textarea>
              <div class="panel-integrations"><span class="panel-integrations-label" data-i18n="aiConnected">Connected:</span><span class="panel-integrations-list" id="integrations-knowledge" data-i18n="aiNone">—</span></div>
            </div>
          </div>
          <div class="panel-chat" data-chat="knowledge">
            <div class="chat-head" data-i18n="aiChatLabel">Chat</div>
            <div class="ai-messages" id="messages-knowledge"></div>
            <div class="ai-offline" data-offline="knowledge" style="display:none;" data-i18n="aiOfflineShort">AI not reachable.</div>
            <div class="ai-quick-actions" data-chat="knowledge">
              <span class="ai-quick-label" data-i18n="aiQuickActions">Actions:</span>
              <button type="button" class="btn btn-sm ai-quick-action" data-chat="knowledge" data-msg="Show my orders" data-i18n="aiActionMyOrders">My orders</button>
              <button type="button" class="btn btn-sm ai-quick-action" data-chat="knowledge" data-msg="My messages summary" data-i18n="aiActionMailSummary">Mail summary</button>
            </div>
            <div class="ai-send" data-send="knowledge">
              <input type="text" data-input="knowledge" data-i18n-placeholder="aiMessagePlaceholder" placeholder="Message…" autocomplete="off">
              <button type="button" class="btn btn-primary" data-sendbtn="knowledge" data-i18n="aiSend">Send</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
  <div id="ai-toast" class="ai-toast" role="status" aria-live="polite" style="display:none;"></div>
  <script src="config.js"></script>
  <script src="js/i18n.js"></script>
  <script src="js/api.js"></script>
  <script src="js/utils.js"></script>
  <script>
    (function () {
      var token = typeof api !== 'undefined' && api && api.getToken && api.getToken();
      if (token) {
        var login = document.getElementById('navLogin');
        var logout = document.getElementById('navLogout');
        if (login) login.style.display = 'none';
        if (logout) { logout.style.display = 'inline'; logout.onclick = function () { api.auth.logout(); location.href = '../index.html'; }; }
      }
      if (typeof window.i18n !== 'undefined' && window.i18n.apply) i18n.apply();
    })();

    function t(key) { return (typeof window.i18n !== 'undefined' && window.i18n.t && window.i18n.t(key)) || key; }
    var toastTimer;
    function showToast(msg) {
      var el = document.getElementById('ai-toast');
      if (!el) return;
      el.textContent = msg;
      el.style.display = 'block';
      clearTimeout(toastTimer);
      toastTimer = setTimeout(function () { el.style.display = 'none'; }, 2500);
    }
    function copyToClipboard(text, btn) {
      if (!navigator.clipboard || !navigator.clipboard.writeText) {
        try { var ta = document.createElement('textarea'); ta.value = text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); } catch (e) { return; }
      } else { navigator.clipboard.writeText(text).catch(function () {}); }
      if (btn) { var orig = btn.textContent; btn.textContent = t('aiCopied'); setTimeout(function () { btn.textContent = orig; }, 1500); }
    }

    var MODULES = ['code', 'data', 'tasks', 'content', 'media', 'knowledge'];
    var MODULES_WITH_CHAT = ['code', 'content', 'knowledge'];
    var currentModule = (location.hash || '#code').replace(/^#/, '') || 'code';
    if (MODULES.indexOf(currentModule) === -1) currentModule = 'code';

    function setActiveModule(id) {
      currentModule = id || 'code';
      location.hash = currentModule;
      document.querySelectorAll('.ai-module-card').forEach(function (el) { el.classList.remove('active'); });
      var card = document.getElementById('mod-' + currentModule);
      if (card) card.classList.add('active');
      document.querySelectorAll('.ai-panel').forEach(function (el) {
        el.classList.toggle('active', el.getAttribute('data-module') === currentModule);
      });
    }

    function applyHash() {
      var hash = (location.hash || '#code').replace(/^#/, '');
      if (MODULES.indexOf(hash) !== -1) setActiveModule(hash);
    }
    document.querySelectorAll('.ai-module-card').forEach(function (a) {
      a.addEventListener('click', function (e) {
        e.preventDefault();
        var mod = a.getAttribute('data-module');
        if (mod) setActiveModule(mod);
      });
    });
    window.addEventListener('hashchange', applyHash);
    applyHash();

    var chatState = {};
    MODULES.forEach(function (m) { chatState[m] = []; });

    function appendMsg(moduleId, text, who, model, options) {
      var el = document.getElementById('messages-' + moduleId);
      if (!el) return null;
      var div = document.createElement('div');
      div.className = 'ai-msg ' + who + (options && options.loading ? ' loading' : '');
      var escaped = (window.escapeHtml ? escapeHtml(text) : text.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'));
      var copyBtn = (who === 'assistant' && text && !options.loading) ? '<div class="msg-actions"><button type="button" class="btn-copy">' + t('aiCopy') + '</button></div>' : '';
      div.innerHTML = '<span class="' + (options && options.loading ? 'typing-dots' : '') + '">' + (options && options.loading ? '…' : escaped) + '</span>' + (model ? '<div class="meta">' + (window.escapeHtml ? escapeHtml(model) : model) + '</div>' : '') + copyBtn;
      if (copyBtn) {
        var btn = div.querySelector('.btn-copy');
        if (btn) btn.addEventListener('click', function () { copyToClipboard(text, btn); });
      }
      el.appendChild(div);
      el.scrollTop = el.scrollHeight;
      if (!options || !options.loading) chatState[moduleId].push({ who: who, text: text, model: model });
      return div;
    }
    function removeLoadingMsg(moduleId, loadingEl) {
      if (loadingEl && loadingEl.parentNode) loadingEl.remove();
    }

    function setOffline(moduleId, show) {
      var off = document.querySelector('.panel-chat[data-chat="' + moduleId + '"] .ai-offline');
      var row = document.querySelector('.panel-chat[data-chat="' + moduleId + '"] .ai-send');
      if (off) off.style.display = show ? 'block' : 'none';
      if (row) row.style.display = show ? 'none' : 'flex';
    }

    function sendMessage(moduleId) {
      var input = document.querySelector('.panel-chat[data-chat="' + moduleId + '"] input[data-input="' + moduleId + '"]');
      if (!input) return;
      var msg = (input.value || '').trim();
      if (!msg) return;
      var base = (typeof AI_URL !== 'undefined' && AI_URL) ? AI_URL : '';
      if (!base) {
        setOffline(moduleId, true);
        appendMsg(moduleId, t('aiOfflineLong'), 'assistant');
        return;
      }
      setOffline(moduleId, false);
      input.value = '';
      appendMsg(moduleId, msg, 'user');
      var btn = document.querySelector('[data-sendbtn="' + moduleId + '"]');
      if (btn) btn.disabled = true;
      var messagesEl = document.getElementById('messages-' + moduleId);
      var loadingEl = appendMsg(moduleId, '…', 'assistant', null, { loading: true });
      var apiToken = (typeof api !== 'undefined' && api && api.getToken) ? api.getToken() : '';
      var apiUrl = (typeof window.API_URL !== 'undefined') ? (window.API_URL || '') : '';
      fetch(base.replace(/\/$/, '') + '/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: msg, module: moduleId, api_token: apiToken || undefined, api_url: apiUrl || undefined })
      }).then(function (r) {
        if (!r.ok) throw new Error(r.statusText);
        return r.json();
      }).then(function (data) {
        removeLoadingMsg(moduleId, loadingEl);
        appendMsg(moduleId, data.reply || 'No reply.', 'assistant', data.model);
      }).catch(function () {
        removeLoadingMsg(moduleId, loadingEl);
        appendMsg(moduleId, t('aiErrorReach'), 'assistant');
        setOffline(moduleId, true);
      }).finally(function () {
        if (btn) btn.disabled = false;
        var inp = document.querySelector('.panel-chat[data-chat="' + moduleId + '"] input[data-input="' + moduleId + '"]');
        if (inp) inp.focus();
      });
    }

    MODULES_WITH_CHAT.forEach(function (m) {
      var input = document.querySelector('input[data-input="' + m + '"]');
      var btn = document.querySelector('[data-sendbtn="' + m + '"]');
      if (input && btn) {
        btn.addEventListener('click', function () { sendMessage(m); });
        input.addEventListener('keydown', function (e) { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(m); } });
      }
    });
    document.querySelectorAll('.ai-quick-action').forEach(function (btn) {
      btn.addEventListener('click', function () {
        var mod = btn.getAttribute('data-chat');
        var msg = (btn.getAttribute('data-msg') || '').trim();
        if (!mod || !msg) return;
        var input = document.querySelector('.panel-chat[data-chat="' + mod + '"] input[data-input="' + mod + '"]');
        if (input) { input.value = msg; sendMessage(mod); }
      });
    });

    function aiSingleRequest(moduleId, payload, resultElId) {
      var el = document.getElementById(resultElId);
      var base = (typeof AI_URL !== 'undefined' && AI_URL) ? AI_URL : '';
      if (!el) return Promise.reject();
      if (!base) { el.style.display = 'block'; el.textContent = t('aiNotConfigured'); el.classList.remove('loading'); return Promise.reject(); }
      el.style.display = 'block'; el.textContent = '…'; el.classList.add('loading');
      var wrap = el.parentNode;
      var copyBtn = null;
      if (wrap && !wrap.classList.contains('ai-single-result-wrap')) {
        var w = document.createElement('div'); w.className = 'ai-single-result-wrap';
        wrap.insertBefore(w, el); w.appendChild(el);
        copyBtn = document.createElement('button'); copyBtn.type = 'button'; copyBtn.className = 'btn btn-sm btn-copy-result'; copyBtn.textContent = t('aiCopy');
        w.appendChild(copyBtn);
      } else if (wrap && wrap.classList.contains('ai-single-result-wrap')) {
        copyBtn = wrap.querySelector('.btn-copy-result');
      }
      return fetch(base.replace(/\/$/, '') + '/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: payload.message || payload, module: moduleId, context: payload.context })
      }).then(function (r) { if (!r.ok) throw new Error(r.statusText); return r.json(); }).then(function (data) {
        var txt = data.reply || '';
        el.textContent = txt; el.classList.remove('loading');
        if (copyBtn) { copyBtn.onclick = function () { copyToClipboard(txt, copyBtn); }; copyBtn.style.display = ''; }
      }).catch(function () {
        el.textContent = t('aiErrorReach'); el.classList.remove('loading');
      });
    }

    if (typeof AI_URL !== 'undefined' && AI_URL) {
      fetch(AI_URL.replace(/\/$/, '') + '/health').then(function (r) { return r.ok ? r.json() : Promise.reject(); }).catch(function () {
        MODULES_WITH_CHAT.forEach(function (m) { setOffline(m, true); });
      });
    } else {
      MODULES_WITH_CHAT.forEach(function (m) { setOffline(m, true); });
    }

    (function initCodePanel() {
      var ta = document.getElementById('workspace-code');
      document.querySelector('#panel-code .ai-btn-save').addEventListener('click', function () {
        if (ta) try { localStorage.setItem('ai_workspace_code', ta.value); showToast(t('aiSaved')); } catch (e) {}
      });
      document.querySelector('#panel-code .ai-btn-clear').addEventListener('click', function () { if (ta) ta.value = ''; });
      if (ta && localStorage.getItem('ai_workspace_code')) ta.value = localStorage.getItem('ai_workspace_code');
    })();

    (function initDataPanel() {
      var ta = document.getElementById('workspace-data');
      var wrap = document.getElementById('data-table-wrap');
      var tbl = document.getElementById('data-table');
      var resultEl = document.getElementById('data-ai-result');
      document.getElementById('data-import-csv').addEventListener('change', function () {
        var f = this.files[0];
        if (!f || !ta) return;
        var r = new FileReader();
        r.onload = function () { ta.value = r.result; };
        r.readAsText(f);
      });
      document.querySelector('#panel-data .ai-btn-parse-data').addEventListener('click', function () {
        if (!ta || !ta.value.trim() || !tbl || !wrap) return;
        var lines = ta.value.trim().split(/\r?\n/);
        function parseCsvLine(line) {
          var out = [], i = 0;
          while (i < line.length) {
            if (line[i] === '"') {
              var end = line.indexOf('"', i + 1);
              var s = line.substring(i + 1, end === -1 ? line.length : end);
              while (end !== -1 && line[end + 1] === '"') { s += '"'; end = line.indexOf('"', end + 2); }
              out.push(s.trim());
              i = end === -1 ? line.length : end + 1;
              if (i < line.length && line[i] === ',') i++;
            } else {
              var comma = line.indexOf(',', i);
              out.push((comma === -1 ? line.substring(i) : line.substring(i, comma)).trim());
              i = comma === -1 ? line.length : comma + 1;
            }
          }
          return out;
        }
        var rows = lines.map(function (l) { return parseCsvLine(l); });
        tbl.innerHTML = '';
        if (rows.length === 0) return;
        var thead = document.createElement('thead');
        var tr = document.createElement('tr');
        rows[0].forEach(function (c) { var th = document.createElement('th'); th.textContent = c; tr.appendChild(th); });
        thead.appendChild(tr); tbl.appendChild(thead);
        var tbody = document.createElement('tbody');
        for (var i = 1; i < rows.length; i++) {
          var r = document.createElement('tr');
          rows[i].forEach(function (c) { var td = document.createElement('td'); td.textContent = c; r.appendChild(td); });
          tbody.appendChild(r);
        }
        tbl.appendChild(tbody);
        wrap.style.display = 'block';
      });
      document.querySelector('#panel-data .ai-btn-export').addEventListener('click', function () {
        if (!ta || !ta.value) return;
        var a = document.createElement('a');
        a.href = 'data:text/csv;charset=utf-8,' + encodeURIComponent(ta.value);
        a.download = 'data.csv';
        a.click();
      });
      document.querySelector('#panel-data .ai-btn-clear').addEventListener('click', function () {
        if (ta) ta.value = '';
        if (wrap) wrap.style.display = 'none';
        if (tbl) tbl.innerHTML = '';
        if (resultEl) { resultEl.style.display = 'none'; resultEl.textContent = ''; }
      });
      document.querySelector('#panel-data .ai-btn-analyze').addEventListener('click', function () {
        var text = (ta && ta.value) ? ta.value.trim().slice(0, 3000) : '';
        aiSingleRequest('data', { message: 'Analyze this data and give short insights:\n' + text }, 'data-ai-result');
      });
    })();

    (function initTasksPanel() {
      var list = document.getElementById('tasks-tasks');
      var addBtn = document.querySelector('#panel-tasks .ai-btn-add-task');
      var input = document.getElementById('tasks-task-input');
      var statusSel = document.getElementById('tasks-task-status');
      var add = document.getElementById('tasks-task-add');
      var addRow = document.querySelector('#panel-tasks .list-add');
      var notesTa = document.getElementById('workspace-tasks');
      var TASKS_KEY = 'ai_tasks_list';
      function saveTasks() {
        if (!list) return;
        var items = [];
        list.querySelectorAll('li').forEach(function (li) {
          var chk = li.querySelector('input[type="checkbox"]');
          var txt = li.querySelector('.text');
          if (txt) items.push({ text: txt.textContent, status: chk && chk.checked ? 'done' : (li.querySelector('.task-status.progress') ? 'progress' : 'todo') });
        });
        try { localStorage.setItem(TASKS_KEY, JSON.stringify(items)); } catch (e) {}
      }
      function addTask(text, status) {
        if (!text || !list) return;
        var st = status || (statusSel ? statusSel.value : 'todo');
        var lab = st === 'done' ? ' done' : (st === 'progress' ? ' progress' : '');
        var li = document.createElement('li');
        li.innerHTML = '<input type="checkbox" ' + (st === 'done' ? 'checked' : '') + '><span class="text">' + (window.escapeHtml ? escapeHtml(text) : text) + '</span><span class="task-status' + lab + '">' + st + '</span><span class="del">×</span>';
        li.querySelector('.del').onclick = function () { li.remove(); saveTasks(); };
        var chk = li.querySelector('input[type="checkbox"]');
        if (chk) chk.addEventListener('change', function () { var sp = li.querySelector('.task-status'); if (sp) { sp.className = 'task-status' + (chk.checked ? ' done' : ''); sp.textContent = chk.checked ? 'done' : 'todo'; } saveTasks(); });
        list.appendChild(li);
        saveTasks();
      }
      try {
        var stored = localStorage.getItem(TASKS_KEY);
        if (stored) { var arr = JSON.parse(stored); if (Array.isArray(arr)) arr.forEach(function (o) { addTask(o.text, o.status); }); }
      } catch (e) {}
      if (addBtn && addRow) addBtn.addEventListener('click', function () { addRow.style.display = addRow.style.display === 'none' ? 'flex' : 'none'; });
      if (add && input) add.addEventListener('click', function () { addTask(input.value.trim(), statusSel ? statusSel.value : 'todo'); input.value = ''; });
      if (input) input.addEventListener('keydown', function (e) { if (e.key === 'Enter') { addTask(input.value.trim(), statusSel ? statusSel.value : 'todo'); input.value = ''; } });
      document.querySelector('#panel-tasks .ai-btn-summarize-notes').addEventListener('click', function () {
        var text = (notesTa && notesTa.value) ? notesTa.value.trim() : '';
        if (!text) { var r = document.getElementById('tasks-ai-result'); if (r) { r.style.display = 'block'; r.textContent = t('aiAddNotesFirst'); } return; }
        aiSingleRequest('tasks', { message: 'Summarize these notes in a few bullet points:\n' + text }, 'tasks-ai-result');
      });
      var pomoStart = document.getElementById('pomo-start');
      var pomoTimer = document.getElementById('pomo-timer');
      var pomoInterval;
      if (pomoStart && pomoTimer) {
        pomoStart.addEventListener('click', function () {
          var sec = 25 * 60;
          pomoTimer.style.display = 'inline-block';
          pomoTimer.textContent = '25:00';
          pomoTimer.classList.add('work');
          if (pomoInterval) clearInterval(pomoInterval);
          pomoInterval = setInterval(function () {
            sec--;
            var m = Math.floor(sec / 60), s = sec % 60;
            pomoTimer.textContent = (m < 10 ? '0' : '') + m + ':' + (s < 10 ? '0' : '') + s;
            if (sec <= 0) { clearInterval(pomoInterval); pomoTimer.classList.remove('work'); }
          }, 1000);
        });
      }
    })();

    (function initContentPanel() {
      var ta = document.getElementById('workspace-content');
      var wc = document.getElementById('content-word-count');
      function updateWordCount() {
        if (!wc || !ta) return;
        var t = (ta.value || '').trim();
        var n = t ? t.split(/\s+/).length : 0;
        wc.textContent = n + ' words';
      }
      if (ta) { ta.addEventListener('input', updateWordCount); updateWordCount(); }
      document.querySelector('#panel-content .ai-btn-save').addEventListener('click', function () {
        if (ta) try { localStorage.setItem('ai_workspace_content', ta.value); showToast(t('aiSaved')); } catch (e) {}
      });
      document.querySelector('#panel-content .ai-btn-clear').addEventListener('click', function () { if (ta) ta.value = ''; if (wc) wc.textContent = '0 words'; });
      var improveBtn = document.getElementById('content-improve-ai');
      if (improveBtn && ta) improveBtn.addEventListener('click', function () {
        var text = (ta.value || '').trim();
        if (!text) return;
        var base = (typeof AI_URL !== 'undefined' && AI_URL) ? AI_URL : '';
        if (!base) { showToast(t('aiNotConfigured')); return; }
        fetch(base.replace(/\/$/, '') + '/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: 'Improve this message for clarity and tone. Reply only with the improved text, no preamble:\n\n' + text, module: 'content' })
        }).then(function (r) { if (!r.ok) throw new Error(r.statusText); return r.json(); }).then(function (data) {
          if (ta && data.reply) ta.value = data.reply.trim();
        }).catch(function () { showToast(t('aiErrorReach')); });
      });
      if (ta && localStorage.getItem('ai_workspace_content')) ta.value = localStorage.getItem('ai_workspace_content'); if (wc && ta) updateWordCount();
    })();

    (function initMediaPanel() {
      var zone = document.getElementById('drop-zone-media');
      var preview = document.getElementById('preview-media');
      var promptInput = document.getElementById('media-ai-prompt');
      var resultEl = document.getElementById('media-ai-result');
      if (zone) {
        zone.addEventListener('dragover', function (e) { e.preventDefault(); zone.classList.add('dragover'); });
        zone.addEventListener('dragleave', function () { zone.classList.remove('dragover'); });
        zone.addEventListener('drop', function (e) {
          e.preventDefault();
          zone.classList.remove('dragover');
          var f = e.dataTransfer.files[0];
          if (f && f.type.indexOf('image') !== -1) {
            var r = new FileReader();
            r.onload = function () { if (preview) preview.innerHTML = '<img src="' + r.result + '" alt="Preview" style="max-width:100%; max-height:200px; border-radius:8px;">'; };
            r.readAsDataURL(f);
          }
        });
      }
      document.querySelector('#panel-media .ai-btn-clear').addEventListener('click', function () {
        if (preview) preview.innerHTML = '';
        if (resultEl) { resultEl.style.display = 'none'; resultEl.textContent = ''; }
        if (promptInput) promptInput.value = '';
      });
      document.getElementById('media-ai-describe').addEventListener('click', function () {
        var msg = (promptInput && promptInput.value.trim()) ? promptInput.value.trim() : 'Describe this image in detail.';
        aiSingleRequest('media', { message: msg }, 'media-ai-result');
      });
    })();

    (function initKnowledgePanel() {
      var ta = document.getElementById('workspace-knowledge');
      document.querySelector('#panel-knowledge .ai-btn-save').addEventListener('click', function () {
        if (ta) try { localStorage.setItem('ai_workspace_knowledge', ta.value); showToast(t('aiSaved')); } catch (e) {}
      });
      document.querySelector('#panel-knowledge .ai-btn-clear').addEventListener('click', function () { if (ta) ta.value = ''; });
      if (ta && localStorage.getItem('ai_workspace_knowledge')) ta.value = localStorage.getItem('ai_workspace_knowledge');
    })();

    (function renderIntegrations() {
      var INTEGRATIONS = window.AI_INTEGRATIONS || { code: [], data: [], tasks: [], content: [], media: [], knowledge: [] };
      MODULES.forEach(function (mod) {
        var el = document.getElementById('integrations-' + mod);
        if (!el) return;
        var list = INTEGRATIONS[mod];
        if (list && list.length > 0) {
          el.innerHTML = list.map(function (name) { return '<span class="tag">' + (window.escapeHtml ? escapeHtml(name) : name) + '</span>'; }).join('');
          el.removeAttribute('data-i18n');
        }
      });
    })();
  </script>
  <script src="../js/main.js"></script>
</body>
</html>
