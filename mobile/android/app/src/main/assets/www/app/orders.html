<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>Orders — OMNIXIUS</title>
  <link rel="stylesheet" href="../css/style.css">
  <link rel="stylesheet" href="css/app.css">
</head>
<body>
  <header class="header">
    <div class="container">
      <a href="../index.html" class="logo">OMNIXIUS</a>
      <nav class="nav nav-main nav-unified">
        <div class="nav-group nav-group-main">
          <span class="nav-group-label">Main</span>
          <a href="../index.html#screens">All screens</a>
          <a href="../index.html#about">About</a>
          <a href="../index.html#map">Map</a>
          <a href="login.html" id="navLogin" class="nav-cta" style="display:none;">Sign in</a>
          <a href="#" id="navLogout">Sign out</a>
        </div>
        <div class="nav-group nav-group-app">
          <span class="nav-group-label">App</span>
          <button type="button" class="nav-drop-trigger" aria-expanded="false" aria-haspopup="true">App ▾</button>
          <div class="nav-drop-panel">
            <a href="marketplace.html">Marketplace</a>
            <a href="mail.html">Mail</a>
            <a href="orders.html">Orders</a>
            <a href="vault.html">Vault</a>
            <a href="dashboard.html">Profile</a>
            <a href="ai.html">AI</a>
          </div>
          <div class="nav-group-app-links">
            <a href="marketplace.html">Marketplace</a>
            <a href="mail.html">Mail</a>
            <a href="orders.html">Orders</a>
            <a href="vault.html">Vault</a>
            <a href="dashboard.html">Profile</a>
            <a href="ai.html">AI</a>
          </div>
        </div>
        <div class="nav-group nav-group-info">
          <span class="nav-group-label">Info</span>
          <a href="../ecosystem.html">Ecosystem</a>
          <a href="../architecture.html">Architecture</a>
          <a href="../contact.html">Contact</a>
        </div>
      </nav>
      <div class="lang-switcher">
        <a href="#" data-lang="en">EN</a>
        <a href="#" data-lang="ru">RU</a>
        <a href="#" data-lang="fr">FR</a>
        <a href="#" data-lang="de">DE</a>
        <a href="#" data-lang="es">ES</a>
        <a href="#" data-lang="it">IT</a>
        <a href="#" data-lang="ar">AR</a>
        <a href="#" data-lang="zh">ZH</a>
        <a href="#" data-lang="ja">JA</a>
      </div>
      <button class="menu-toggle" aria-label="Menu"><span></span></button>
    </div>
  </header>
  <main class="app-page">
    <div class="container">
      <h1 data-i18n="ordersTitle">My orders</h1>
      <section class="orders-section" id="asBuyerSection">
        <h2 data-i18n="ordersAsBuyer">As buyer</h2>
        <div id="asBuyerList"><p class="loading-state">Loading…</p></div>
      </section>
      <section class="orders-section" id="asSellerSection">
        <h2 data-i18n="ordersAsSeller">As seller</h2>
        <div id="asSellerList"></div>
      </section>
    </div>
  </main>
  <script src="config.js"></script>
  <script src="js/i18n.js"></script>
  <script src="js/api.js"></script>
  <script src="js/utils.js"></script>
  <script src="js/nav-unread.js"></script>
  <script>
    if (typeof api === 'undefined' || !api.getToken || !api.getToken()) { location.href = 'login.html'; return; }
    document.getElementById('navLogout').onclick = () => { api.auth.logout(); location.href = '../index.html'; };

    var t = function(k) { return (typeof i18n !== 'undefined' && i18n.t) ? i18n.t(k) : k; };
    function renderOrderCard(o, role) {
      const img = o.image_path ? (window.API_URL + '/uploads/' + o.image_path) : '';
      const date = o.created_at ? new Date(o.created_at * 1000).toLocaleDateString(undefined, { dateStyle: 'medium' }) : '';
      const other = o.seller_name || o.buyer_name || '';
      const statusClass = (o.status || '').toLowerCase();
      const installRequested = (o.installment_plan || '') === 'requested';
      const installBtn = (role === 'buyer' && !installRequested)
        ? `<button type="button" class="btn btn-sm btn-installment" data-order-id="${o.id}">${t('installmentRequestBtn') || 'Request installments'}</button>`
        : (installRequested ? `<span class="installment-requested">${t('installmentRequested') || 'Installments requested (coming via Trade)'}</span>` : '');
      return `
        <article class="order-card" data-order-id="${o.id}">
          ${img ? `<img src="${img}" alt="" class="order-card-img">` : ''}
          <div class="order-card-body">
            <h3 class="order-card-title">${escapeHtml(o.title || '')}</h3>
            <p class="order-card-meta">${escapeHtml(other)} · ${date}</p>
            <p class="order-card-price">${typeof o.price === 'number' ? o.price.toFixed(2) : o.price}</p>
            <span class="order-status order-status-${statusClass}">${escapeHtml(o.status || '')}</span>
            ${installBtn ? '<p class="order-installment">' + installBtn + '</p>' : ''}
          </div>
        </article>
      `;
    }

    (async () => {
      try {
        const data = await api.users.myOrders();
        const asBuyer = data.asBuyer || [];
        const asSeller = data.asSeller || [];
        document.getElementById('asBuyerList').innerHTML = asBuyer.length
          ? '<div class="orders-grid">' + asBuyer.map(o => renderOrderCard(o, 'buyer')).join('') + '</div>'
          : '<div class="empty-state"><p class="empty-state-title" data-i18n="noOrders">No orders yet.</p><p class="empty-state-text">Buy or sell on the Marketplace to see orders here.</p></div>';
        document.getElementById('asSellerList').innerHTML = asSeller.length
          ? '<div class="orders-grid">' + asSeller.map(o => renderOrderCard(o, 'seller')).join('') + '</div>'
          : '<p class="orders-empty" data-i18n="noOrders">No orders yet.</p>';
        document.querySelectorAll('.btn-installment').forEach(function(btn) {
          btn.onclick = async function() {
            var orderId = this.getAttribute('data-order-id');
            this.disabled = true;
            try {
              await api.orders.update(orderId, { installment_plan: 'requested' });
              this.outerHTML = '<span class="installment-requested">' + (t('installmentRequested') || 'Installments requested (coming via Trade)') + '</span>';
            } catch (err) {
              alert(err.data && err.data.error ? err.data.error : 'Failed');
              this.disabled = false;
            }
          };
        });
        if (typeof i18n !== 'undefined') i18n.apply();
      } catch (e) {
        document.getElementById('asBuyerList').innerHTML = '<p class="error">Failed to load orders.</p>';
        document.getElementById('asSellerList').innerHTML = '';
      }
    })().catch(() => { api.auth.logout(); location.href = 'login.html'; });
  </script>
  <script src="../js/main.js"></script>
</body>
</html>
