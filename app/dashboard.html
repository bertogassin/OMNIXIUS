<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard — OMNIXIUS</title>
  <link rel="stylesheet" href="../css/style.css">
  <link rel="stylesheet" href="css/app.css">
</head>
<body>
  <header class="header">
    <div class="container">
      <a href="../index.html" class="logo">OMNIXIUS</a>
      <nav class="nav">
        <a href="marketplace.html">Marketplace</a>
        <a href="mail.html">Mail</a>
        <a href="orders.html">Orders</a>
        <a href="dashboard.html">Profile</a>
        <a href="../index.html">Site</a>
        <a href="#" id="logout">Sign out</a>
        <span class="lang-switcher"><a href="#" data-lang="en">EN</a> | <a href="#" data-lang="ru">RU</a> | <a href="#" data-lang="fr">FR</a></span>
      </nav>
    </div>
  </header>
  <main class="app-page">
    <div class="container">
      <div id="welcome" class="dashboard-welcome"></div>
      <div id="quickLinks" class="quick-links"></div>
      <h1>Profile</h1>
      <div id="profile"><p class="loading-state">Loading…</p></div>
      <h2 id="orders" style="margin-top:2rem;">My orders</h2>
      <div id="ordersList"><p class="loading-state">Loading…</p></div>
    </div>
  </main>
  <script src="config.js"></script>
  <script src="js/i18n.js"></script>
  <script src="js/api.js"></script>
  <script src="js/nav-unread.js"></script>
  <script>
    (function () {
      var params = new URLSearchParams(location.search);
      var token = params.get('token');
      if (token) {
        var apiUrl = params.get('api_url');
        if (apiUrl) localStorage.setItem('omnixius_api_url', apiUrl);
        localStorage.setItem('omnixius_token', token);
        var name = params.get('name');
        var email = params.get('email');
        if (email) {
          var user = { email: email, name: name || '' };
          localStorage.setItem('omnixius_user', JSON.stringify(user));
        }
        history.replaceState(null, '', location.pathname);
        location.reload();
        return;
      }
    })();
    if (!api.getToken()) { location.href = 'login.html'; return; }
    document.getElementById('logout').onclick = () => { api.auth.logout(); location.href = '../index.html'; };

    (async () => {
      const u = await api.users.me();
      const orders = await api.users.myOrders();
      var name = u.name || u.email || 'User';
      document.getElementById('welcome').innerHTML = '<h1 class="welcome-title">Hello, ' + (name.length > 25 ? name.slice(0, 22) + '…' : name) + '</h1>';
      document.getElementById('quickLinks').innerHTML = '<div class="quick-links-grid"><a href="marketplace.html" class="quick-link"><span class="quick-link-icon">◆</span><span>Marketplace</span></a><a href="mail.html" class="quick-link"><span class="quick-link-icon">✉</span><span>Mail</span></a><a href="orders.html" class="quick-link"><span class="quick-link-icon">◇</span><span>Orders</span></a></div>';
      document.getElementById('profile').innerHTML = '<p><img class="profile-avatar" src="' + (u.avatar_path ? (window.API_URL + '/uploads/' + u.avatar_path) : 'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 80 80%22><rect fill=%22%23333%22 width=%2280%22 height=%2280%22/><text x=%2250%25%22 y=%2255%25%22 fill=%22%23888%22 text-anchor=%22middle%22 dy=%22.3em%22 font-size=%2224%22>?</text></svg>') + '" alt=""></p><p><strong>' + (u.name || '—') + '</strong> · ' + u.email + '</p><p style="color:var(--text-muted);">Role: ' + u.role + '</p><p><a href="profile-edit.html" class="btn btn-primary" style="display:inline-block; margin-top:0.5rem;">Edit</a></p>';
      var list = (orders.asBuyer || []).concat(orders.asSeller || []).slice(0, 20);
      document.getElementById('ordersList').innerHTML = list.length
        ? '<ul class="mail-list">' + list.map(function(o) { return '<li><span>' + o.title + ' — ' + o.status + '</span><span>' + new Date(o.created_at * 1000).toLocaleDateString() + '</span></li>'; }).join('') + '</ul>'
        : '<p style="color:var(--text-muted);">No orders yet. <a href="marketplace.html">Go to Marketplace</a></p>';
    })().catch(function() { api.auth.logout(); location.href = 'login.html'; });
  </script>
</body>
</html>
