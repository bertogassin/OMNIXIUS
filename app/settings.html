<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>Settings — OMNIXIUS</title>
  <link rel="stylesheet" href="../css/style.css">
  <link rel="stylesheet" href="css/app.css">
</head>
<body>
  <header class="header">
    <div class="container">
      <a href="../index.html" class="logo">OMNIXIUS</a>
      <nav class="nav nav-main nav-unified">
        <div class="nav-group nav-group-main">
          <span class="nav-group-label" data-i18n="navMain">Main</span>
          <a href="../index.html" data-i18n="home">Home</a>
          <a href="login.html" id="navLogin" class="nav-cta" data-i18n="signIn">Sign in</a>
          <a href="#" id="navLogout" style="display:none;" data-i18n="signOut">Sign out</a>
        </div>
        <div class="nav-group nav-group-app">
          <span class="nav-group-label" data-i18n="navApp">App</span>
          <a href="marketplace.html" data-i18n="navTrove">Trove · marketplace</a>
          <a href="mail.html" data-i18n="navRelay">Relay · mail</a>
          <a href="orders.html" data-i18n="navOrders">Orders</a>
          <a href="dashboard.html" data-i18n="navProfile">Profile</a>
          <a href="notifications.html">Notifications</a>
          <a href="ai.html" data-i18n="navOracle">Oracle · AI</a>
        </div>
        <div class="nav-group nav-group-more nav-drop">
          <span class="nav-group-label" data-i18n="navMore">More</span>
          <button type="button" class="nav-drop-trigger" aria-expanded="false" aria-haspopup="true"><span data-i18n="navMore">More</span> ▾</button>
          <div class="nav-drop-panel">
            <a href="trade.html" data-i18n="brandForge">Forge · trade & finance</a>
            <a href="wallet.html">Wallet</a>
            <a href="remittances.html">Remittances</a>
            <a href="connect.html" data-i18n="brandBond">Bond · social</a>
            <a href="repositorium.html" data-i18n="brandArk">Ark · storage</a>
            <a href="ixi.html" data-i18n="brandIxi">IXI · blockchain</a>
            <a href="vault.html" data-i18n="brandCrate">Crate · files</a>
            <a href="learning.html" data-i18n="brandAscent">Ascent · learning</a>
            <a href="startups.html" data-i18n="brandFlare">Flare · startups</a>
            <a href="media.html" data-i18n="brandLens">Lens · media</a>
            <a href="rewards.html" data-i18n="brandBounty">Bounty · rewards</a>
            <a href="settings.html" style="color:var(--accent);">Settings</a>
          </div>
          <div class="nav-group-app-links">
            <a href="trade.html" data-i18n="brandForge">Forge</a>
            <a href="wallet.html">Wallet</a>
            <a href="remittances.html">Remittances</a>
            <a href="connect.html" data-i18n="brandBond">Bond</a>
            <a href="repositorium.html" data-i18n="brandArk">Ark</a>
            <a href="ixi.html" data-i18n="brandIxi">IXI</a>
            <a href="vault.html" data-i18n="brandCrate">Crate</a>
            <a href="learning.html" data-i18n="brandAscent">Ascent</a>
            <a href="startups.html" data-i18n="brandFlare">Flare</a>
            <a href="media.html" data-i18n="brandLens">Lens</a>
            <a href="rewards.html" data-i18n="brandBounty">Bounty</a>
            <a href="settings.html">Settings</a>
          </div>
        </div>
        <div class="nav-group nav-group-info nav-drop">
          <span class="nav-group-label" data-i18n="navInfo">Info</span>
          <button type="button" class="nav-drop-trigger" aria-expanded="false" aria-haspopup="true"><span data-i18n="navInfo">Info</span> ▾</button>
          <div class="nav-drop-panel">
            <a href="../ecosystem.html" data-i18n="navEcosystem">Ecosystem</a>
            <a href="../architecture.html" data-i18n="navArchitecture">Architecture</a>
            <a href="../contact.html" data-i18n="navContact">Contact</a>
          </div>
          <div class="nav-group-app-links">
            <a href="../ecosystem.html">Ecosystem</a>
            <a href="../architecture.html">Architecture</a>
            <a href="../contact.html">Contact</a>
          </div>
        </div>
      </nav>
      <div class="lang-switcher">
        <a href="#" data-lang="en">EN</a>
        <a href="#" data-lang="ru">RU</a>
        <a href="#" data-lang="fr">FR</a>
        <a href="#" data-lang="de">DE</a>
        <a href="#" data-lang="es">ES</a>
        <a href="#" data-lang="it">IT</a>
        <a href="#" data-lang="ar">AR</a>
        <a href="#" data-lang="zh">ZH</a>
        <a href="#" data-lang="ja">JA</a>
      </div>
      <button class="menu-toggle" aria-label="Menu"><span></span></button>
    </div>
  </header>
  <main class="app-page">
    <div class="container">
      <h1>Settings</h1>
      <p class="about-text">Security, sessions, devices, recovery, and notifications.</p>

      <section class="settings-section card" style="padding:1.25rem; margin-top:1.5rem;">
        <h2 class="section-title">Security — Change password</h2>
        <div class="app-form" style="max-width:360px;">
          <label>Current password <input type="password" id="pwdCurrent" class="input" autocomplete="current-password"></label>
          <label>New password <input type="password" id="pwdNew" class="input" autocomplete="new-password" minlength="8"></label>
          <label>Confirm new password <input type="password" id="pwdConfirm" class="input" autocomplete="new-password"></label>
          <button type="button" class="btn btn-primary" id="pwdSubmit">Change password</button>
          <p id="pwdMessage" class="text-muted" style="margin-top:0.5rem;"></p>
        </div>
      </section>

      <section class="settings-section card" style="padding:1.25rem; margin-top:1.5rem;">
        <h2 class="section-title">Sessions</h2>
        <p class="text-muted" style="margin-bottom:0.75rem;">Active sessions. Revoking logs out that device.</p>
        <div id="sessionsList"><p class="loading-state">Loading…</p></div>
      </section>

      <section class="settings-section card" style="padding:1.25rem; margin-top:1.5rem;">
        <h2 class="section-title">Devices</h2>
        <p class="text-muted" style="margin-bottom:0.75rem;">Trusted devices. Removing revokes that device.</p>
        <div id="devicesList"><p class="loading-state">Loading…</p></div>
      </section>

      <section class="settings-section card" style="padding:1.25rem; margin-top:1.5rem;">
        <h2 class="section-title">Recovery phrase</h2>
        <p class="text-muted" style="margin-bottom:0.75rem;">Store a recovery phrase to restore access later (e.g. on forgot-password flow). Save the phrase securely; it is hashed before sending.</p>
        <label class="app-form">Recovery phrase <input type="text" id="recoveryPhrase" class="input" placeholder="Enter a phrase to save (e.g. generated below)"></label>
        <p><button type="button" class="btn btn-outline btn-sm" id="recoveryGenerate">Generate random phrase</button> <button type="button" class="btn btn-primary btn-sm" id="recoveryStore">Store recovery phrase</button></p>
        <p id="recoveryMessage" class="text-muted" style="margin-top:0.5rem;"></p>
      </section>

      <section class="settings-section card" style="padding:1.25rem; margin-top:1.5rem;">
        <h2 class="section-title">Notifications</h2>
        <div id="notifSettings"><p class="loading-state">Loading…</p></div>
      </section>
    </div>
  </main>
  <script src="config.js"></script>
  <script src="js/api.js"></script>
  <script src="../js/main.js"></script>
  <script>
    if (!api.getToken()) { location.href = 'login.html'; }
    (function(){ var t = api.getToken(); document.getElementById('navLogin').style.display = t ? 'none' : ''; document.getElementById('navLogout').style.display = t ? '' : 'none'; })();
    document.getElementById('navLogout').onclick = function(e){ e.preventDefault(); if (api.auth) api.auth.logout(); location.href = 'login.html'; };

    function fmtDate(ts) {
      if (ts == null || ts === undefined) return '—';
      return new Date(ts * 1000).toLocaleString();
    }

    async function hashPhrase(phrase) {
      var enc = new TextEncoder().encode(phrase);
      var buf = await crypto.subtle.digest('SHA-256', enc);
      return Array.from(new Uint8Array(buf)).map(function(b) { return b.toString(16).padStart(2, '0'); }).join('');
    }

    document.getElementById('pwdSubmit').onclick = async function() {
      var cur = document.getElementById('pwdCurrent').value;
      var newP = document.getElementById('pwdNew').value;
      var conf = document.getElementById('pwdConfirm').value;
      var msg = document.getElementById('pwdMessage');
      if (!cur || !newP || !conf) { msg.textContent = 'Fill all fields.'; return; }
      if (newP !== conf) { msg.textContent = 'New password and confirm do not match.'; return; }
      if (newP.length < 8) { msg.textContent = 'New password must be at least 8 characters.'; return; }
      msg.textContent = 'Updating…';
      try {
        await api.auth.changePassword(cur, newP);
        msg.textContent = 'Password changed.';
        msg.style.color = 'var(--accent)';
        document.getElementById('pwdCurrent').value = '';
        document.getElementById('pwdNew').value = '';
        document.getElementById('pwdConfirm').value = '';
      } catch (e) {
        msg.textContent = e.data && e.data.error ? e.data.error : 'Failed.';
        msg.style.color = 'var(--text)';
      }
    };

    function loadSessions() {
      var el = document.getElementById('sessionsList');
      api.auth.sessions().then(function(res) {
        var list = res.sessions || [];
        if (list.length === 0) { el.innerHTML = '<p class="text-muted">No active sessions.</p>'; return; }
        var html = '<ul class="settings-list">';
        list.forEach(function(s) {
          html += '<li class="settings-list-item"><span>' + (s.device_name || 'Session') + ' · ' + fmtDate(s.created_at) + ' – ' + fmtDate(s.expires_at) + '</span> <button type="button" class="btn btn-outline btn-sm revoke-session" data-id="' + s.id + '">Revoke</button></li>';
        });
        html += '</ul>';
        el.innerHTML = html;
        el.querySelectorAll('.revoke-session').forEach(function(btn) {
          btn.onclick = function() {
            var id = btn.getAttribute('data-id');
            api.auth.sessionDelete(id).then(function() {
              loadSessions();
            }).catch(function(e) {
              if (e.status === 401) { api.auth.logout(); location.href = 'login.html'; return; }
              alert(e.data && e.data.error ? e.data.error : 'Failed');
            });
          };
        });
      }).catch(function(e) {
        if (e.status === 401) { api.auth.logout(); location.href = 'login.html'; return; }
        document.getElementById('sessionsList').innerHTML = '<p class="text-muted">Could not load sessions.</p>';
      });
    }

    function loadDevices() {
      var el = document.getElementById('devicesList');
      api.auth.devices().then(function(res) {
        var list = res.devices || [];
        if (list.length === 0) { el.innerHTML = '<p class="text-muted">No devices.</p>'; return; }
        var html = '<ul class="settings-list">';
        list.forEach(function(d) {
          html += '<li class="settings-list-item"><span>' + (d.name || 'Device') + ' · ' + fmtDate(d.last_used || d.created_at) + '</span> <button type="button" class="btn btn-outline btn-sm remove-device" data-id="' + d.id + '">Remove</button></li>';
        });
        html += '</ul>';
        el.innerHTML = html;
        el.querySelectorAll('.remove-device').forEach(function(btn) {
          btn.onclick = function() {
            var id = btn.getAttribute('data-id');
            api.auth.deviceDelete(id).then(function() { loadDevices(); }).catch(function(e) { alert(e.data && e.data.error ? e.data.error : 'Failed'); });
          };
        });
      }).catch(function() { el.innerHTML = '<p class="text-muted">Could not load devices.</p>'; });
    }

    document.getElementById('recoveryGenerate').onclick = function() {
      var words = 'alpha beta gamma delta echo foxtrot golf hotel india juliet kilo lima mike november oscar papa quebec romeo sierra tango uniform victor whiskey xray yankee zulu'.split(' ');
      var out = [];
      for (var i = 0; i < 8; i++) out.push(words[Math.floor(Math.random() * words.length)]);
      document.getElementById('recoveryPhrase').value = out.join(' ');
    };

    document.getElementById('recoveryStore').onclick = async function() {
      var phrase = (document.getElementById('recoveryPhrase').value || '').trim();
      var msg = document.getElementById('recoveryMessage');
      if (!phrase) { msg.textContent = 'Enter or generate a phrase.'; return; }
      msg.textContent = 'Storing…';
      try {
        var h = await hashPhrase(phrase);
        await api.auth.recoveryGenerate(h);
        msg.textContent = 'Recovery phrase stored. Save it securely.';
        msg.style.color = 'var(--accent)';
      } catch (e) {
        msg.textContent = e.data && e.data.error ? e.data.error : 'Failed.';
        msg.style.color = 'var(--text)';
      }
    };

    function loadNotifications() {
      var el = document.getElementById('notifSettings');
      api.notifications.settings().then(function(s) {
        var email = s.email_enabled !== false;
        var push = s.push_enabled !== false;
        el.innerHTML = '<label class="settings-check"><input type="checkbox" id="notifEmail" ' + (email ? 'checked' : '') + '> Email notifications</label><label class="settings-check"><input type="checkbox" id="notifPush" ' + (push ? 'checked' : '') + '> Push notifications</label>';
        document.getElementById('notifEmail').onchange = function() {
          api.notifications.updateSettings({ email_enabled: document.getElementById('notifEmail').checked }).catch(function() {});
        };
        document.getElementById('notifPush').onchange = function() {
          api.notifications.updateSettings({ push_enabled: document.getElementById('notifPush').checked }).catch(function() {});
        };
      }).catch(function() { el.innerHTML = '<p class="text-muted">Could not load notification settings.</p>'; });
    }

    loadSessions();
    loadDevices();
    loadNotifications();
  </script>
  <style>
    .settings-section .section-title { margin-top: 0; }
    .settings-list { list-style: none; padding: 0; margin: 0; }
    .settings-list-item { display: flex; flex-wrap: wrap; align-items: center; justify-content: space-between; gap: 0.5rem; padding: 0.5rem 0; border-bottom: 1px solid var(--border); }
    .settings-list-item:last-child { border-bottom: none; }
    .settings-check { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; cursor: pointer; }
  </style>
</body>
</html>
