(function () {
  const STORAGE_KEY = 'omnixius_lang';
  const defaultLang = 'en';
  const strings = {
    en: {
      navMarketplace: 'Marketplace',
      navMail: 'Mail',
      navOrders: 'Orders',
      navProfile: 'Profile',
      navSite: 'Site',
      signIn: 'Sign in',
      signOut: 'Sign out',
      register: 'Register',
      ordersTitle: 'My orders',
      ordersHint: 'Purchases and sales in one place.',
      ordersAsBuyer: 'As buyer',
      ordersAsSeller: 'As seller',
      noOrders: 'No orders yet.',
      setApiUrl: 'Set API URL',
      apiUrlHint: 'Backend URL not set. You cannot sign in or register until you set it.',
      email: 'Email',
      password: 'Password',
      passwordMin: 'Password (min 8 characters)',
      name: 'Name',
      loginTitle: 'Sign in',
      registerTitle: 'Register',
      forgotPassword: 'Forgot password?',
      noAccount: 'No account? Register',
      haveAccount: 'Already have an account? Sign in',
      signInFailed: 'Sign in failed',
      registerFailed: 'Registration failed',
      cannotConnect: 'Cannot reach server. Set API URL?',
      confirmPassword: 'Confirm password',
      passwordMismatch: 'Passwords do not match',
      rememberMe: 'Keep me signed in',
      agreeTerms: 'I agree to the Terms and Privacy',
      agreeTermsPrefix: 'I agree to the',
      termsAndPrivacy: 'Terms and Privacy',
      createAccount: 'Create account',
      registering: 'Creating account…',
      registerSubtitle: 'Create your OMNIXIUS account.',
      marketplaceTitle: 'Marketplace',
      searchPlaceholder: 'Search',
      cityPlaceholder: 'City',
      allCategories: 'All categories',
      priceFrom: 'Price from',
      priceTo: 'to',
      searchBtn: 'Search',
      addListing: 'Add listing',
      noResults: 'No results',
      noResultsHint: 'Try different filters or add your own listing.',
      loadFailed: 'Failed to load. Try again.',
      retry: 'Retry',
      loading: 'Loading…',
      noPhoto: 'No photo',
      namePlaceholder: 'Your name',
      emailAlreadyRegistered: 'This email is already registered. Sign in or use another email.',
      changeApiUrl: 'Change API URL',
      signingIn: 'Signing in…',
      invalidEmail: 'Please enter a valid email address.',
      passwordTooShort: 'Password must be at least 8 characters.',
      emailRules: 'Allowed: letters, numbers, @ and a dot. Example: name@domain.com. Max 255 characters.',
      passwordRules: 'Allowed: letters (A–Z, a–z), numbers (0–9), symbols (!@#$%^&* etc.). 8–128 characters.',
      nameRules: 'Optional. Letters, spaces, hyphens. Max 200 characters.',
      emailValid: 'Valid email',
      passwordLengthOk: '8–128 characters',
      passwordsMatch: 'Passwords match',
      nameMax: 'Up to 200 characters',
      passwordTooLong: 'Password must be up to 128 characters.',
      mailTitle: 'Internal mail',
      mailSubtitle: 'Inbox and sent conversations.',
      noConversations: 'No conversations yet.',
      noConversationsHint: 'Start from a product page: contact the seller.',
      backToMarketplace: '← Marketplace',
      backToMail: '← Mail',
      seller: 'Seller',
      contactSeller: 'Contact seller',
      signInToContact: 'Sign in to contact the seller.',
      productIdMissing: 'Product ID missing.',
      settingsTitle: 'Settings',
      save: 'Save',
      profilePhoto: 'Profile photo',
      messagePlaceholder: 'Message',
      send: 'Send',
      conversationCreated: 'Conversation created. Send a message.',
      specifyConvId: 'Specify conversation id or userId.',
      noMessages: 'No messages yet. Say hello!',
      changePassword: 'Change password',
      currentPassword: 'Current password',
      newPassword: 'New password',
      changePasswordSuccess: 'Password changed.',
      currentPasswordWrong: 'Current password is incorrect.',
    },
    ru: {
      navMarketplace: 'Маркетплейс',
      navMail: 'Почта',
      navOrders: 'Заказы',
      navProfile: 'Профиль',
      navSite: 'Сайт',
      signIn: 'Войти',
      signOut: 'Выйти',
      register: 'Регистрация',
      ordersTitle: 'Мои заказы',
      ordersHint: 'Покупки и продажи в одном месте.',
      ordersAsBuyer: 'Как покупатель',
      ordersAsSeller: 'Как продавец',
      noOrders: 'Пока заказов нет.',
      setApiUrl: 'Указать URL API',
      apiUrlHint: 'URL бэкенда не задан. Вход и регистрация недоступны.',
      email: 'Email',
      password: 'Пароль',
      passwordMin: 'Пароль (не менее 8 символов)',
      name: 'Имя',
      loginTitle: 'Вход',
      registerTitle: 'Регистрация',
      forgotPassword: 'Забыли пароль?',
      noAccount: 'Нет аккаунта? Зарегистрироваться',
      haveAccount: 'Уже есть аккаунт? Войти',
      signInFailed: 'Ошибка входа',
      registerFailed: 'Ошибка регистрации',
      cannotConnect: 'Нет связи с сервером. Указать URL API?',
      confirmPassword: 'Повторите пароль',
      passwordMismatch: 'Пароли не совпадают',
      rememberMe: 'Сохранить вход',
      agreeTerms: 'Я согласен с Условиями и Политикой конфиденциальности',
      agreeTermsPrefix: 'Я согласен с',
      termsAndPrivacy: 'Условиями и Политикой конфиденциальности',
      createAccount: 'Создать аккаунт',
      registering: 'Создаём аккаунт…',
      registerSubtitle: 'Создайте аккаунт OMNIXIUS.',
      marketplaceTitle: 'Маркетплейс',
      searchPlaceholder: 'Поиск',
      cityPlaceholder: 'Город',
      allCategories: 'Все категории',
      priceFrom: 'Цена от',
      priceTo: 'до',
      searchBtn: 'Искать',
      addListing: 'Добавить объявление',
      noResults: 'Ничего не найдено',
      noResultsHint: 'Измените фильтры или добавьте своё объявление.',
      loadFailed: 'Не удалось загрузить. Попробуйте снова.',
      retry: 'Повторить',
      loading: 'Загрузка…',
      noPhoto: 'Нет фото',
      namePlaceholder: 'Ваше имя',
      emailAlreadyRegistered: 'Этот email уже зарегистрирован. Войдите или укажите другой.',
      changeApiUrl: 'Изменить URL API',
      signingIn: 'Вход…',
      invalidEmail: 'Введите корректный email.',
      passwordTooShort: 'Пароль не менее 8 символов.',
      emailRules: 'Допустимы: буквы, цифры, @ и точка. Пример: name@domain.com. Не более 255 символов.',
      passwordRules: 'Допустимы: буквы (A–Z, a–z), цифры (0–9), символы (!@#$%^&* и др.). 8–128 символов.',
      nameRules: 'Необязательно. Буквы, пробелы, дефис. Не более 200 символов.',
      emailValid: 'Email корректен',
      passwordLengthOk: '8–128 символов',
      passwordsMatch: 'Пароли совпадают',
      nameMax: 'Не более 200 символов',
      passwordTooLong: 'Пароль не более 128 символов.',
      mailTitle: 'Внутренняя почта',
      mailSubtitle: 'Входящие и отправленные диалоги.',
      noConversations: 'Пока нет диалогов.',
      noConversationsHint: 'Начните со страницы товара: напишите продавцу.',
      backToMarketplace: '← Маркетплейс',
      backToMail: '← Почта',
      seller: 'Продавец',
      contactSeller: 'Написать продавцу',
      signInToContact: 'Войдите, чтобы написать продавцу.',
      productIdMissing: 'Не указан ID товара.',
      settingsTitle: 'Настройки',
      save: 'Сохранить',
      profilePhoto: 'Фото профиля',
      messagePlaceholder: 'Сообщение',
      send: 'Отправить',
      conversationCreated: 'Диалог создан. Напишите сообщение.',
      specifyConvId: 'Укажите id диалога или userId.',
      noMessages: 'Пока нет сообщений. Напишите первым!',
      changePassword: 'Сменить пароль',
      currentPassword: 'Текущий пароль',
      newPassword: 'Новый пароль',
      changePasswordSuccess: 'Пароль изменён.',
      currentPasswordWrong: 'Неверный текущий пароль.',
    },
    fr: {
      navMarketplace: 'Marketplace',
      navMail: 'Mail',
      navOrders: 'Commandes',
      navProfile: 'Profil',
      navSite: 'Site',
      signIn: 'Connexion',
      signOut: 'Déconnexion',
      register: 'Inscription',
      ordersTitle: 'Mes commandes',
      ordersHint: 'Achats et ventes au même endroit.',
      ordersAsBuyer: 'En tant qu\'acheteur',
      ordersAsSeller: 'En tant que vendeur',
      noOrders: 'Aucune commande pour l\'instant.',
      setApiUrl: 'Définir l\'URL API',
      apiUrlHint: 'URL du backend non définie. Connexion et inscription indisponibles.',
      email: 'Email',
      password: 'Mot de passe',
      passwordMin: 'Mot de passe (min. 8 caractères)',
      name: 'Nom',
      loginTitle: 'Connexion',
      registerTitle: 'Inscription',
      forgotPassword: 'Mot de passe oublié ?',
      noAccount: 'Pas de compte ? S\'inscrire',
      haveAccount: 'Déjà un compte ? Connexion',
      signInFailed: 'Échec de la connexion',
      registerFailed: 'Échec de l\'inscription',
      cannotConnect: 'Impossible de joindre le serveur. Définir l\'URL API ?',
      confirmPassword: 'Confirmer le mot de passe',
      passwordMismatch: 'Les mots de passe ne correspondent pas',
      rememberMe: 'Rester connecté',
      agreeTerms: 'J\'accepte les Conditions et la Politique de confidentialité',
      agreeTermsPrefix: 'J\'accepte les',
      termsAndPrivacy: 'Conditions et la Politique de confidentialité',
      createAccount: 'Créer un compte',
      registering: 'Création du compte…',
      registerSubtitle: 'Créez votre compte OMNIXIUS.',
      marketplaceTitle: 'Marketplace',
      searchPlaceholder: 'Rechercher',
      cityPlaceholder: 'Ville',
      allCategories: 'Toutes les catégories',
      priceFrom: 'Prix à partir de',
      priceTo: 'à',
      searchBtn: 'Rechercher',
      addListing: 'Ajouter une annonce',
      noResults: 'Aucun résultat',
      noResultsHint: 'Modifiez les filtres ou ajoutez votre annonce.',
      loadFailed: 'Échec du chargement. Réessayez.',
      retry: 'Réessayer',
      loading: 'Chargement…',
      noPhoto: 'Pas de photo',
      namePlaceholder: 'Votre nom',
      emailAlreadyRegistered: 'Cet email est déjà inscrit. Connectez-vous ou utilisez un autre.',
      changeApiUrl: 'Changer l\'URL API',
      signingIn: 'Connexion…',
      invalidEmail: 'Veuillez entrer une adresse email valide.',
      passwordTooShort: 'Le mot de passe doit contenir au moins 8 caractères.',
      emailRules: 'Autorisés : lettres, chiffres, @ et un point. Ex. : name@domain.com. Max 255 caractères.',
      passwordRules: 'Autorisés : lettres (A–Z, a–z), chiffres (0–9), symboles (!@#$%^&* etc.). 8–128 caractères.',
      nameRules: 'Optionnel. Lettres, espaces, tirets. Max 200 caractères.',
      emailValid: 'Email valide',
      passwordLengthOk: '8–128 caractères',
      passwordsMatch: 'Les mots de passe correspondent',
      nameMax: 'Jusqu\'à 200 caractères',
      passwordTooLong: 'Le mot de passe doit faire au plus 128 caractères.',
      mailTitle: 'Mail interne',
      mailSubtitle: 'Conversations reçues et envoyées.',
      noConversations: 'Aucune conversation pour l\'instant.',
      noConversationsHint: 'Commencez par une annonce : contactez le vendeur.',
      backToMarketplace: '← Marketplace',
      backToMail: '← Mail',
      seller: 'Vendeur',
      contactSeller: 'Contacter le vendeur',
      signInToContact: 'Connectez-vous pour contacter le vendeur.',
      productIdMissing: 'ID produit manquant.',
      settingsTitle: 'Paramètres',
      save: 'Enregistrer',
      profilePhoto: 'Photo de profil',
      messagePlaceholder: 'Message',
      send: 'Envoyer',
      conversationCreated: 'Conversation créée. Envoyez un message.',
      specifyConvId: 'Indiquez l\'id de conversation ou userId.',
      noMessages: 'Aucun message. Dites bonjour !',
      changePassword: 'Changer le mot de passe',
      currentPassword: 'Mot de passe actuel',
      newPassword: 'Nouveau mot de passe',
      changePasswordSuccess: 'Mot de passe modifié.',
      currentPasswordWrong: 'Mot de passe actuel incorrect.',
    },
  };

  function getLang() {
    return localStorage.getItem(STORAGE_KEY) || defaultLang;
  }
  function setLang(lang) {
    if (strings[lang]) {
      localStorage.setItem(STORAGE_KEY, lang);
      document.documentElement.lang = lang;
      if (typeof apply === 'function') apply();
      return true;
    }
    return false;
  }
  function t(key) {
    const lang = getLang();
    return (strings[lang] && strings[lang][key]) || (strings[defaultLang] && strings[defaultLang][key]) || key;
  }
  function apply() {
    document.querySelectorAll('[data-i18n]').forEach(function (el) {
      const key = el.getAttribute('data-i18n');
      if (key && t(key) !== key) el.textContent = t(key);
    });
    document.querySelectorAll('[data-i18n-placeholder]').forEach(function (el) {
      const key = el.getAttribute('data-i18n-placeholder');
      if (key) el.placeholder = t(key);
    });
    const cur = getLang();
    document.querySelectorAll('.lang-switcher a[data-lang]').forEach(function (a) {
      a.classList.toggle('active', a.getAttribute('data-lang') === cur);
    });
  }

  window.i18n = {
    getLang,
    setLang,
    t,
    apply,
    defaultLang,
    supported: ['en', 'ru', 'fr'],
  };
  document.documentElement.lang = getLang();
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function () {
      apply();
      document.querySelectorAll('.lang-switcher a[data-lang]').forEach(function (a) {
        a.addEventListener('click', function (e) { e.preventDefault(); setLang(a.getAttribute('data-lang')); apply(); });
      });
    });
  } else { apply(); }
})();
